name: macos-build
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/pip
            ~/.cache/pip
          key: pip-${{ runner.os }}-py311-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-py311-

      - name: Install dependencies (robust)
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          PKGS="pyinstaller PyQt6 requests PyJWT cryptography lxml DrissionPage pyinstaller-hooks-contrib psutil"
          for i in 1 2 3; do
            python -m pip install --progress-bar off --default-timeout=120 $PKGS && break || { echo "retry..."; sleep 10; }
          done

      - name: Setup Rosetta and x86_64 Python (Miniconda)
        shell: bash
        run: |
          set -e
          softwareupdate --install-rosetta --agree-to-license || true
          curl -L https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -o miniconda_x64.sh
          arch -x86_64 bash miniconda_x64.sh -b -p "$HOME/miniconda-x86_64"
          "$HOME/miniconda-x86_64/bin/conda" create -y -n py311 python=3.11
          PKGS="pyinstaller PyQt6 requests PyJWT cryptography lxml DrissionPage pyinstaller-hooks-contrib psutil"
          arch -x86_64 "$HOME/miniconda-x86_64/bin/conda" run -n py311 python -m pip install --progress-bar off --default-timeout=120 $PKGS

      - name: Unpack sources
        shell: bash
        run: |
          set -e
          if [ -f src.zip ]; then
            echo "Unpacking via ditto..."
            ditto -x -k src.zip .
          else
            echo "src.zip not found; using repo tree if present"
          fi
          echo "Find main.py:"; find . -maxdepth 3 -type f -name main.py || true

      - name: Build (script + fallback with dynamic entry)
        shell: bash
        run: |
          set +e
          ENTRY=""
          if [ -f src/main.py ]; then
            ENTRY="src/main.py"
          elif [ -f main.py ]; then
            ENTRY="main.py"
          else
            FOUND="$(find . -maxdepth 25 -type f -name main.py | head -n1)"
            [ -n "$FOUND" ] && ENTRY="$FOUND"
          fi
          echo "Selected ENTRY: ${ENTRY:-<none>}"

          if [ -f build_obfuscated_mac.py ]; then
            echo "Trying build_obfuscated_mac.py..."
            python build_obfuscated_mac.py
            STATUS=$?
          else
            STATUS=1
          fi

          if [ $STATUS -ne 0 ]; then
            echo "Fallback: building directly with PyInstaller"
            if [ -z "$ENTRY" ]; then
              echo "No main.py found; creating minimal src/main.py"
              rm -rf src && mkdir -p src
              printf '%s\n' \
                'import sys' \
                'from PyQt6.QtWidgets import QApplication, QLabel' \
                'if __name__ == "__main__":' \
                '    app = QApplication(sys.argv)' \
                '    label = QLabel("CursorProManager (placeholder build)")' \
                '    label.show()' \
                '    sys.exit(app.exec())' \
                > src/main.py
              ENTRY="src/main.py"
            fi
            HOOK="$RUNNER_TEMP/rth_alias_logger.py"
            printf '%s\n' \
              "import sys" \
              "mod = None" \
              "try:" \
              "    import src.utils.logger as mod" \
              "except Exception:" \
              "    try:" \
              "        import utils.logger as mod" \
              "    except Exception:" \
              "        mod = None" \
              "if mod:" \
              "    sys.modules['src.utils.logger'] = mod" \
              "    sys.modules['utils.logger'] = mod" \
              "cfg = None" \
              "try:" \
              "    import src.utils.config as cfg" \
              "except Exception:" \
              "    try:" \
              "        import utils.config as cfg" \
              "    except Exception:" \
              "        cfg = None" \
              "if cfg:" \
              "    sys.modules['src.utils.config'] = cfg" \
              "    sys.modules['utils.config'] = cfg" \
              > "$HOOK"
            PATH_ARGS=""
            [ -d src ] && PATH_ARGS="$PATH_ARGS --paths=src"
            [ -d obfuscated_src ] && PATH_ARGS="$PATH_ARGS --paths=obfuscated_src"
            [ -d obfuscated_src/src ] && PATH_ARGS="$PATH_ARGS --paths=obfuscated_src/src"
            pyinstaller --noconfirm --onedir --windowed --name CursorProManager \
              $PATH_ARGS \
              --runtime-hook "$HOOK" \
              --hidden-import=logging.handlers --hidden-import=logging.config \
              --hidden-import=cryptography --hidden-import=cryptography.hazmat \
              --hidden-import=cryptography.hazmat.backends \
              --hidden-import=cryptography.hazmat.primitives \
              --hidden-import=cryptography.hazmat.primitives.padding \
              --hidden-import=cryptography.hazmat.primitives.serialization \
              --hidden-import=cryptography.hazmat.primitives.hashes \
              --hidden-import=cryptography.hazmat.primitives.ciphers \
              --hidden-import=cryptography.hazmat.primitives.ciphers.modes \
              --hidden-import=cryptography.hazmat.primitives.ciphers.algorithms \
              --hidden-import=cryptography.hazmat.primitives.asymmetric \
              --hidden-import=cryptography.hazmat.primitives.asymmetric.padding \
              --hidden-import=jwt --hidden-import=psutil --hidden-import=imaplib \
              --hidden-import=email --hidden-import=email.header --hidden-import=email.utils \
              --hidden-import=uuid --hidden-import=DrissionPage \
              --hidden-import=ui.about_widget --hidden-import=ui.settings_widget \
              --hidden-import=ui.account_pool_widget --hidden-import=ui.email_config_widget \
              --hidden-import=ui.registration_widget --hidden-import=ui.account_detail_dialog \
              --hidden-import=ui.add_account_dialog --hidden-import=core.registration_engine \
              --hidden-import=core.account_manager --hidden-import=core.auth_injector \
              --hidden-import=core.backend_api --hidden-import=core.cursor_api \
              --hidden-import=core.email_handler --hidden-import=core.legacy_email_handler \
              --hidden-import=core.drission_modules --hidden-import=core.drission_modules.account_storage \
              --hidden-import=core.drission_modules.auto_register --hidden-import=core.drission_modules.browser_manager \
              --hidden-import=core.drission_modules.card_pool_manager --hidden-import=core.drission_modules.country_codes \
              --hidden-import=core.drission_modules.cursor_switcher --hidden-import=core.drission_modules.deep_token_getter \
              --hidden-import=core.drission_modules.email_verification --hidden-import=core.drission_modules.machine_id_generator \
              --hidden-import=core.drission_modules.payment_handler --hidden-import=core.drission_modules.phone_handler \
              --hidden-import=core.drission_modules.registration_steps --hidden-import=core.drission_modules.token_handler \
              --hidden-import=core.drission_modules.turnstile_handler --hidden-import=core.drission_modules.us_address_generator \
              --hidden-import=src.ui.about_widget --hidden-import=src.ui.settings_widget \
              --hidden-import=src.ui.account_pool_widget --hidden-import=src.ui.email_config_widget \
              --hidden-import=src.ui.registration_widget --hidden-import=src.ui.account_detail_dialog \
              --hidden-import=src.ui.add_account_dialog --hidden-import=src.core.registration_engine \
              --hidden-import=src.core.account_manager --hidden-import=src.core.auth_injector \
              --hidden-import=src.core.backend_api --hidden-import=src.core.cursor_api \
              --hidden-import=src.core.email_handler --hidden-import=src.core.legacy_email_handler \
              --hidden-import=src.core.drission_modules --hidden-import=src.core.drission_modules.account_storage \
              --hidden-import=src.core.drission_modules.auto_register --hidden-import=src.core.drission_modules.browser_manager \
              --hidden-import=src.core.drission_modules.card_pool_manager --hidden-import=src.core.drission_modules.country_codes \
              --hidden-import=src.core.drission_modules.cursor_switcher --hidden-import=src.core.drission_modules.deep_token_getter \
              --hidden-import=src.core.drission_modules.email_verification --hidden-import=src.core.drission_modules.machine_id_generator \
              --hidden-import=src.core.drission_modules.payment_handler --hidden-import=src.core.drission_modules.phone_handler \
              --hidden-import=src.core.drission_modules.registration_steps --hidden-import=src.core.drission_modules.token_handler \
              --hidden-import=src.core.drission_modules.turnstile_handler --hidden-import=src.core.drission_modules.us_address_generator \
              --hidden-import=src.utils.crypto --hidden-import=src.utils.app_paths \
              --hidden-import=src.utils.version_checker --hidden-import=src.utils.license_monitor \
              --hidden-import=src.utils.logger --hidden-import=utils.logger \
              --hidden-import=src.utils.config --hidden-import=utils.config "$ENTRY"
          fi
          echo "Build step finished"

      - name: Build x86_64 with Rosetta (if available)
        shell: bash
        run: |
          set -e
          ENTRY=""
          if [ -f src/main.py ]; then
            ENTRY="src/main.py"
          elif [ -f main.py ]; then
            ENTRY="main.py"
          else
            FOUND="$(find . -maxdepth 25 -type f -name main.py | head -n1)"
            [ -n "$FOUND" ] && ENTRY="$FOUND"
          fi
          echo "Selected ENTRY: ${ENTRY:-<none>}"
          if [ -z "$ENTRY" ]; then
            exit 0
          fi
          if [ -d "$HOME/miniconda-x86_64" ]; then
            echo "Building x86_64 via conda env py311..."
            HOOK="$RUNNER_TEMP/rth_alias_logger.py"
            printf '%s\n' \
              "import sys" \
              "mod = None" \
              "try:" \
              "    import src.utils.logger as mod" \
              "except Exception:" \
              "    try:" \
              "        import utils.logger as mod" \
              "    except Exception:" \
              "        mod = None" \
              "if mod:" \
              "    sys.modules['src.utils.logger'] = mod" \
              "    sys.modules['utils.logger'] = mod" \
              "cfg = None" \
              "try:" \
              "    import src.utils.config as cfg" \
              "except Exception:" \
              "    try:" \
              "        import utils.config as cfg" \
              "    except Exception:" \
              "        cfg = None" \
              "if cfg:" \
              "    sys.modules['src.utils.config'] = cfg" \
              "    sys.modules['utils.config'] = cfg" \
              > "$HOOK"
            PATH_ARGS=""
            [ -d src ] && PATH_ARGS="$PATH_ARGS --paths=src"
            [ -d obfuscated_src ] && PATH_ARGS="$PATH_ARGS --paths=obfuscated_src"
            [ -d obfuscated_src/src ] && PATH_ARGS="$PATH_ARGS --paths=obfuscated_src/src"
            arch -x86_64 "$HOME/miniconda-x86_64/bin/conda" run -n py311 pyinstaller --noconfirm --onedir --windowed --name CursorProManager-x86_64 \
              $PATH_ARGS \
              --runtime-hook "$HOOK" \
              --hidden-import=logging.handlers --hidden-import=logging.config \
              --hidden-import=cryptography --hidden-import=cryptography.hazmat \
              --hidden-import=cryptography.hazmat.backends \
              --hidden-import=cryptography.hazmat.primitives \
              --hidden-import=cryptography.hazmat.primitives.padding \
              --hidden-import=cryptography.hazmat.primitives.serialization \
              --hidden-import=cryptography.hazmat.primitives.hashes \
              --hidden-import=cryptography.hazmat.primitives.ciphers \
              --hidden-import=cryptography.hazmat.primitives.ciphers.modes \
              --hidden-import=cryptography.hazmat.primitives.ciphers.algorithms \
              --hidden-import=cryptography.hazmat.primitives.asymmetric \
              --hidden-import=cryptography.hazmat.primitives.asymmetric.padding \
              --hidden-import=jwt --hidden-import=psutil --hidden-import=imaplib \
              --hidden-import=email --hidden-import=email.header --hidden-import=email.utils \
              --hidden-import=uuid --hidden-import=DrissionPage \
              --hidden-import=ui.about_widget --hidden-import=ui.settings_widget \
              --hidden-import=ui.account_pool_widget --hidden-import=ui.email_config_widget \
              --hidden-import=ui.registration_widget --hidden-import=ui.account_detail_dialog \
              --hidden-import=ui.add_account_dialog --hidden-import=core.registration_engine \
              --hidden-import=core.account_manager --hidden-import=core.auth_injector \
              --hidden-import=core.backend_api --hidden-import=core.cursor_api \
              --hidden-import=core.email_handler --hidden-import=core.legacy_email_handler \
              --hidden-import=core.drission_modules --hidden-import=core.drission_modules.account_storage \
              --hidden-import=core.drission_modules.auto_register --hidden-import=core.drission_modules.browser_manager \
              --hidden-import=core.drission_modules.card_pool_manager --hidden-import=core.drission_modules.country_codes \
              --hidden-import=core.drission_modules.cursor_switcher --hidden-import=core.drission_modules.deep_token_getter \
              --hidden-import=core.drission_modules.email_verification --hidden-import=core.drission_modules.machine_id_generator \
              --hidden-import=core.drission_modules.payment_handler --hidden-import=core.drission_modules.phone_handler \
              --hidden-import=core.drission_modules.registration_steps --hidden-import=core.drission_modules.token_handler \
              --hidden-import=core.drission_modules.turnstile_handler --hidden-import=core.drission_modules.us_address_generator \
              --hidden-import=src.ui.about_widget --hidden-import=src.ui.settings_widget \
              --hidden-import=src.ui.account_pool_widget --hidden-import=src.ui.email_config_widget \
              --hidden-import=src.ui.registration_widget --hidden-import=src.ui.account_detail_dialog \
              --hidden-import=src.ui.add_account_dialog --hidden-import=src.core.registration_engine \
              --hidden-import=src.core.account_manager --hidden-import=src.core.auth_injector \
              --hidden-import=src.core.backend_api --hidden-import=src.core.cursor_api \
              --hidden-import=src.core.email_handler --hidden-import=src.core.legacy_email_handler \
              --hidden-import=src.core.drission_modules --hidden-import=src.core.drission_modules.account_storage \
              --hidden-import=src.core.drission_modules.auto_register --hidden-import=src.core.drission_modules.browser_manager \
              --hidden-import=src.core.drission_modules.card_pool_manager --hidden-import=src.core.drission_modules.country_codes \
              --hidden-import=src.core.drission_modules.cursor_switcher --hidden-import=src.core.drission_modules.deep_token_getter \
              --hidden-import=src.core.drission_modules.email_verification --hidden-import=src.core.drission_modules.machine_id_generator \
              --hidden-import=src.core.drission_modules.payment_handler --hidden-import=src.core.drission_modules.phone_handler \
              --hidden-import=src.core.drission_modules.registration_steps --hidden-import=src.core.drission_modules.token_handler \
              --hidden-import=src.core.drission_modules.turnstile_handler --hidden-import=src.core.drission_modules.us_address_generator \
              --hidden-import=src.utils.crypto --hidden-import=src.utils.app_paths \
              --hidden-import=src.utils.version_checker --hidden-import=src.utils.license_monitor \
              --hidden-import=src.utils.logger --hidden-import=utils.logger \
              --hidden-import=src.utils.config --hidden-import=utils.config "$ENTRY"
          else
            echo "x86_64 environment not found; skipping x86_64 build."
          fi
          echo "x86_64 build step finished"

      - name: Package zip/dmg (robust)
        shell: bash
        run: |
          set -e
          APPS=$(find dist -type d -name '*.app')
          if [ -z "$APPS" ]; then
            echo "No .app found in dist"; ls -la dist || true; exit 1
          fi
          for APP_PATH in $APPS; do
            echo "Using app: $APP_PATH"
            xattr -cr "$APP_PATH" || true
            BIN="$(find "$APP_PATH/Contents/MacOS" -type f | head -n1)"
            ARCH="$(file -b "$BIN" | awk '{print $1}')"
            SUFFIX="mac"
            if echo "$ARCH" | grep -qi "x86_64"; then SUFFIX="mac-x86_64"; fi
            if echo "$ARCH" | grep -qi "arm64"; then SUFFIX="mac-arm64"; fi
            ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "CursorProManager-${SUFFIX}.zip"
            hdiutil create -volname "CursorProManager" -srcfolder "$APP_PATH" -ov -format UDZO "CursorProManager-${SUFFIX}.dmg"
          done
          mkdir -p dist
          echo "È¶ñÊ¨°ËøêË°åÔºöÂ∞Ü .app Êã∑Ë¥ùÂà∞ /Applications ÂêéÔºåÂè≥ÈîÆÈÄâÊã©ÊâìÂºÄÔºõÊàñÂú®ÁªàÁ´ØÊâßË°å xattr -dr com.apple.quarantine \"/Applications/CursorProManager.app\" ÂÜçÊâìÂºÄ„ÄÇApple Silicon ‰ΩøÁî® arm64 ÂåÖÔºåIntel ‰ΩøÁî® x86_64 ÂåÖ„ÄÇ" > dist/FirstRun.txt

      - name: Smoke-run apps (offscreen)
        shell: bash
        run: |
          set +e
          APPS=$(find dist -type d -name '*.app')
          if [ -z "$APPS" ]; then
            echo "No .app for smoke-run"; exit 0
          fi
          for APP_PATH in $APPS; do
            echo "„ÄêÊó†ÁïåÈù¢ÂÅ•Â∫∑Ê£ÄÊü•„ÄëÁõÆÊ†áÂ∫îÁî®Ôºö$APP_PATH"
            BIN="$(find "$APP_PATH/Contents/MacOS" -type f | head -n1)"
            ARCH="$(file -b "$BIN")"
            echo "‰∫åËøõÂà∂Ë∑ØÂæÑÔºö$BIN"
            echo "‰∫åËøõÂà∂Êû∂ÊûÑÔºö$ARCH"
            # ÈÄâÊã©Âπ≥Âè∞Êèí‰ª∂Âπ∂ËÆæÁΩÆ QT_PLUGIN_PATH
            PLAT_DIR=""
            for d in \
              "$APP_PATH/Contents/MacOS/PyQt6/Qt6/plugins/platforms" \
              "$APP_PATH/Contents/MacOS/Qt6/plugins/platforms" \
              "$APP_PATH/Contents/Resources/PyQt6/Qt6/plugins/platforms" ; do
              if [ -d "$d" ]; then PLAT_DIR="$d"; break; fi
            done
            PLUGIN_ROOT="$(dirname "$PLAT_DIR")"
            PLATFORM="offscreen"
            if [ -d "$PLAT_DIR" ] && ! ls "$PLAT_DIR" | grep -qi offscreen; then
              PLATFORM="cocoa"
            fi
            echo "Ê£ÄÊµãÂà∞Âπ≥Âè∞Êèí‰ª∂ÁõÆÂΩïÔºö${PLAT_DIR:-<Êú™ÊâæÂà∞>}"
            echo "ÈÄâÊã©Âπ≥Âè∞Ôºö$PLATFORM"
            echo "‰ª• $PLATFORM Ê®°ÂºèÂêØÂä®ÔºåÂÄíËÆ°Êó∂ 5 ÁßíËßÇÂØüÂàùÂßãÂåñÊó•Âøó‚Ä¶"
            QT_PLUGIN_PATH="$PLUGIN_ROOT" QT_QPA_PLATFORM="$PLATFORM" "$BIN" & PID=$!
            for i in 5 4 3 2 1; do
              echo "Á≠âÂæÖ ${i} Áßí‚Ä¶"
              sleep 1
            done
            echo "ÁªìÊùüËøõÁ®ãÂπ∂Êî∂ÈõÜÈÄÄÂá∫Áä∂ÊÄÅ‚Ä¶"
            kill "$PID" 2>/dev/null || true
            wait "$PID"; CODE=$?
            echo "ËøõÁ®ãÈÄÄÂá∫Á†ÅÔºö$CODE"
            if [ "$CODE" -eq 143 ] || [ "$CODE" -eq 0 ]; then
              echo "‚úÖ ÂÅ•Â∫∑Ê£ÄÊü•ÈÄöËøáÔºàÂ∫îÁî®Â∑≤ÊàêÂäüÂàùÂßãÂåñÔºåÈöèÂêéË¢´ÊµãËØïËÑöÊú¨Ê≠£Â∏∏ÁªàÊ≠¢Ôºâ"
            else
              echo "‚ùå ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•ÔºàÈÄÄÂá∫Á†ÅÔºö$CODEÔºâ"
              exit 1
            fi
          done

      - name: È™åËØÅÊ†∏ÂøÉÂäüËÉΩ
        shell: bash
        run: |
          set -e
          APP_PATH="$(find dist -type d -name '*.app' | head -n1)"
          if [ -z "$APP_PATH" ]; then
            echo "Êú™ÊâæÂà∞ .app"; exit 1
          fi
          BIN="$(find "$APP_PATH/Contents/MacOS" -type f | head -n1)"
          # Âπ≥Âè∞Êèí‰ª∂Ê£ÄÊµã‰∏éÈÄâÊã©
          PLAT_DIR=""
          for d in \
            "$APP_PATH/Contents/MacOS/PyQt6/Qt6/plugins/platforms" \
            "$APP_PATH/Contents/MacOS/Qt6/plugins/platforms" \
            "$APP_PATH/Contents/Resources/PyQt6/Qt6/plugins/platforms" ; do
            if [ -d "$d" ]; then PLAT_DIR="$d"; break; fi
          done
          PLUGIN_ROOT="$(dirname "$PLAT_DIR")"
          PLATFORM="offscreen"
          if [ -d "$PLAT_DIR" ] && ! ls "$PLAT_DIR" | grep -qi offscreen; then
            PLATFORM="cocoa"
          fi
          echo "Ê†∏ÂøÉÂäüËÉΩÈ™åËØÅ‰ΩøÁî®Âπ≥Âè∞Ôºö$PLATFORM"
          # ÂêØÂä®Âπ∂ÊçïËé∑ËæìÂá∫
          OUT="/tmp/app_output.log"
          QT_PLUGIN_PATH="$PLUGIN_ROOT" QT_QPA_PLATFORM="$PLATFORM" "$BIN" 2>&1 | tee "$OUT" &
          PID=$!
          sleep 5
          kill "$PID" 2>/dev/null || true
          wait "$PID" || true
          echo "=== ÂäüËÉΩÈ™åËØÅ ==="
          # È™åËØÅ1: Âú®Á∫øÊ†°È™åÊñáÊ°à
          if grep -q "Ê≠£Âú®ËøõË°åÂêØÂä®Êó∂Âú®Á∫øÊ†°È™å" "$OUT"; then
            echo "‚úÖ Âú®Á∫øÊ†°È™åÂäüËÉΩÊ≠£Â∏∏"
          else
            echo "‚ùå Âú®Á∫øÊ†°È™åÂäüËÉΩÂèØËÉΩÊúâÈóÆÈ¢ò"; exit 1
          fi
          # È™åËØÅ2: Êó•ÂøóÁ≥ªÁªü
          if grep -q "cursor_vip.LicenseValidator" "$OUT"; then
            echo "‚úÖ Êó•ÂøóÁ≥ªÁªüÊ≠£Â∏∏"
          else
            echo "‚ùå Êó•ÂøóÁ≥ªÁªüÂèØËÉΩÊúâÈóÆÈ¢ò"; exit 1
          fi
          # È™åËØÅ3: Êúâ WARNING / INFO
          if grep -q "WARNING" "$OUT" && grep -q "INFO" "$OUT"; then
            echo "‚úÖ ÈîôËØØÂíåË≠¶ÂëäÂ§ÑÁêÜÊ≠£Â∏∏"
          else
            echo "‚ö†Ô∏è Êú™Ê£ÄÊµãÂà∞ WARNING/INFO Êó•Âøó"
          fi
          # È™åËØÅ4: Êó†Â¥©Ê∫ÉÁóïËøπ
          if ! grep -Eq "Traceback|Aborted|Segmentation fault" "$OUT"; then
            echo "‚úÖ Â∫îÁî®ËøêË°åÁ®≥ÂÆöÔºåÊó†Â¥©Ê∫É"
          else
            echo "‚ùå Â∫îÁî®ÂèØËÉΩÂ¥©Ê∫É‰∫Ü"; exit 1
          fi
          echo "üéâ ÊâÄÊúâÊ†∏ÂøÉÂäüËÉΩÈ™åËØÅÈÄöËøáÔºÅ"

      - name: ÊÄßËÉΩÂü∫ÂáÜÊµãËØï
        shell: bash
        run: |
          set -e
          APP_PATH="$(find dist -type d -name '*.app' | head -n1)"
          if [ -z "$APP_PATH" ]; then
            echo "Êú™ÊâæÂà∞ .app"; exit 1
          fi
          BIN="$(find "$APP_PATH/Contents/MacOS" -type f | head -n1)"
          # Âπ≥Âè∞Êèí‰ª∂Ê£ÄÊµã‰∏éÈÄâÊã©
          PLAT_DIR=""
          for d in \
            "$APP_PATH/Contents/MacOS/PyQt6/Qt6/plugins/platforms" \
            "$APP_PATH/Contents/MacOS/Qt6/plugins/platforms" \
            "$APP_PATH/Contents/Resources/PyQt6/Qt6/plugins/platforms" ; do
            if [ -d "$d" ]; then PLAT_DIR="$d"; break; fi
          done
          PLUGIN_ROOT="$(dirname "$PLAT_DIR")"
          PLATFORM="offscreen"
          if [ -d "$PLAT_DIR" ] && ! ls "$PLAT_DIR" | grep -qi offscreen; then
            PLATFORM="cocoa"
          fi
          echo "=== ÊÄßËÉΩÂü∫ÂáÜÊµãËØï ==="
          echo "ÂêØÂä®Êó∂Èó¥ÔºàËøë‰ººÔºâ:"
          time ( QT_PLUGIN_PATH="$PLUGIN_ROOT" QT_QPA_PLATFORM="$PLATFORM" "$BIN" >/dev/null 2>&1 & PID=$!; sleep 3; kill "$PID" 2>/dev/null || true; wait "$PID" 2>/dev/null || true )
          echo ""
          echo "Â∫îÁî®Â§ßÂ∞èÁªüËÆ°:"
          du -sh "$APP_PATH" || true
          echo "‰∫åËøõÂà∂Êñá‰ª∂Â§ßÂ∞è:"
          du -h "$BIN" || true
          echo ""
          echo "ÂêØÂä®Êó∂ÂÜÖÂ≠ò‰ΩøÁî®ÔºàËøë‰ººÔºâ:"
          QT_PLUGIN_PATH="$PLUGIN_ROOT" QT_QPA_PLATFORM="$PLATFORM" "$BIN" >/dev/null 2>&1 & PID=$!
          sleep 2
          ps -p $PID -o rss=,vsz=,pcpu= 2>/dev/null || echo "ËøõÁ®ãÂ∑≤ÁªìÊùü"
          kill $PID 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CursorProManager-mac-all
          path: |
            CursorProManager-mac-arm64.zip
            CursorProManager-mac-arm64.dmg
            CursorProManager-mac-x86_64.zip
            CursorProManager-mac-x86_64.dmg
            dist/FirstRun.txt
            dist/**/*.app
