name: macos-build
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
jobs:
  build-macos:
    runs-on: macos-latest
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/pip
            ~/.cache/pip
          key: pip-${{ runner.os }}-py311-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-py311-
      - name: Install dependencies (robust)
        shell: bash
        run: |
          set -e
          echo "Python: $(python --version)"
          python -m pip install --upgrade pip setuptools wheel
          if [ -f requirements.txt ]; then
            for i in 1 2 3; do
              echo "Attempt $i: installing requirements.txt..."
              python -m pip install --progress-bar off --default-timeout=120 -r requirements.txt && break || {
                echo "pip install failed, retrying..."
                sleep 10
              }
            done
          else
            PKGS="pyinstaller PyQt6 requests PyJWT cryptography lxml DrissionPage pyinstaller-hooks-contrib psutil"
            for i in 1 2 3; do
              echo "Attempt $i: installing deps..."
              python -m pip install --progress-bar off --default-timeout=120 $PKGS && break || {
                echo "pip install failed, retrying..."
                sleep 10
              }
            done
          fi
      - name: Build (script + fallback)
        shell: bash
        run: |
          set +e
          echo "Trying build_obfuscated_mac.py..."
          python build_obfuscated_mac.py
          STATUS=$?
          if [ $STATUS -ne 0 ]; then
            echo "Fallback: building directly with PyInstaller"
            ENTRY="src/main.py"
            [ -f obfuscated_src/main.py ] && ENTRY="obfuscated_src/main.py"
            if [ ! -f "$ENTRY" ]; then
              echo "Creating minimal src/main.py"
              rm -rf src
              mkdir -p src
              cat > src/main.py <<'PY'
              import sys
              from PyQt6.QtWidgets import QApplication, QLabel
              if __name__ == "__main__":
                  app = QApplication(sys.argv)
                  label = QLabel("CursorProManager (placeholder build)")
                  label.show()
                  sys.exit(app.exec())
              PY
              ENTRY="src/main.py"
            fi
            EXTRA_ARGS=""
            if pyinstaller --help | grep -q -- '--target-arch'; then
              if [ -n "${MACOS_TARGET_ARCH:-}" ]; then
                EXTRA_ARGS="--target-arch ${MACOS_TARGET_ARCH}"
              fi
            fi
            pyinstaller --noconfirm --onedir --windowed --name CursorProManager $EXTRA_ARGS "$ENTRY"
          fi
          echo "Build step finished"
      - name: Codesign app (optional)
        shell: bash
        env:
          MACOS_CODESIGN_IDENTITY: ${{ secrets.MACOS_CODESIGN_IDENTITY }}
        run: |
          set -e
          APP_PATH="$(find dist -type d \( -name 'CursorProManager.app' -o -name '*.app' \) | head -n1)"
          if [ -z "$APP_PATH" ]; then
            exit 0
          fi
          if [ -z "${MACOS_CODESIGN_IDENTITY:-}" ]; then
            exit 0
          fi
          if [ -f entitlements.plist ]; then
            codesign -s "$MACOS_CODESIGN_IDENTITY" --deep --force --options runtime --entitlements entitlements.plist "$APP_PATH"
          else
            codesign -s "$MACOS_CODESIGN_IDENTITY" --deep --force --options runtime "$APP_PATH"
          fi
      - name: Notarize app (optional)
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -e
          if [ -z "${APPLE_ID:-}" ] || [ -z "${APPLE_APP_PASSWORD:-}" ] || [ -z "${APPLE_TEAM_ID:-}" ]; then
            exit 0
          fi
          ZIP_PATH="CursorProManager-mac.zip"
          if [ ! -f "$ZIP_PATH" ]; then
            APP_PATH="$(find dist -type d \( -name 'CursorProManager.app' -o -name '*.app' \) | head -n1)"
            if [ -z "$APP_PATH" ]; then
              exit 0
            fi
            ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$ZIP_PATH"
          fi
          xcrun notarytool submit "$ZIP_PATH" --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID" --password "$APPLE_APP_PASSWORD" --wait
      - name: Staple app (optional)
        shell: bash
        run: |
          set -e
          APP_PATH="$(find dist -type d \( -name 'CursorProManager.app' -o -name '*.app' \) | head -n1)"
          if [ -z "$APP_PATH" ]; then
            exit 0
          fi
          xcrun stapler staple "$APP_PATH"
      - name: Package zip/dmg (robust)
        shell: bash
        run: |
          set -e
          APP_PATH="$(find dist -type d \( -name 'CursorProManager.app' -o -name '*.app' \) | head -n1)"
          if [ -z "$APP_PATH" ]; then
            echo "No .app found in dist"
            ls -la dist || true
            exit 1
          fi
          echo "Using app: $APP_PATH"

          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "CursorProManager-mac.zip"
          hdiutil create -volname "CursorProManager" -srcfolder "$APP_PATH" -ov -format UDZO "CursorProManager-mac.dmg"

          mkdir -p dist
          echo "首次运行：右键应用选择打开；或在终端执行 xattr -dr com.apple.quarantine \"/Applications/$(basename "$APP_PATH")\" 后再打开。" > dist/FirstRun.txt
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CursorProManager-mac
          path: |
            CursorProManager-mac.zip
            CursorProManager-mac.dmg
            dist/FirstRun.txt
            dist/**/*.app
