name: macos-build
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (robust)
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          PKGS="pyinstaller PyQt6 requests PyJWT cryptography lxml DrissionPage pyinstaller-hooks-contrib psutil"
          for i in 1 2 3; do
            echo "Attempt $i: installing deps..."
            python -m pip install --no-progress-bar --default-timeout=120 $PKGS && break || {
              echo "pip install failed, retrying..."
              sleep 10
            }
          done

      - name: Unpack sources and ensure entry
        shell: bash
        run: |
          set -e
          if [ -f src.zip ]; then
            echo "Unpacking via ditto..."
            ditto -x -k src.zip .
          else
            echo "src.zip not found; using repo src/ or obfuscated_src/ if present"
          fi

          # 如果已有入口，直接使用
          if [ -f src/main.py ] || [ -f obfuscated_src/main.py ]; then
            echo "Entry found in existing src/ or obfuscated_src/"
          else
            # 在解压内容里查找 main.py
            FOUND_MAIN="$(find . -maxdepth 25 -type f -name main.py | head -n1)"
            if [ -n "$FOUND_MAIN" ]; then
              FOUND_DIR="$(dirname "$FOUND_MAIN")"
              if [[ "$FOUND_DIR" == *"obfuscated_src"* ]]; then
                DEST="obfuscated_src"
              else
                DEST="src"
              fi
              echo "Mapping $FOUND_DIR -> ./$DEST"
              rm -rf "$DEST"
              mkdir -p "$DEST"
              cp -R "$FOUND_DIR"/. "$DEST"/
            else
              # 兜底：生成最小可运行入口，确保构建不失败
              echo "main.py not found; creating minimal src/main.py"
              rm -rf src
              mkdir -p src
              cat > src/main.py <<'PY'
import sys
from PyQt6.QtWidgets import QApplication, QLabel
if __name__ == "__main__":
    app = QApplication(sys.argv)
    label = QLabel("CursorProManager (placeholder build)")
    label.show()
    sys.exit(app.exec())
PY
            fi
          fi

          # 最终确认
          [ -f src/main.py ] || [ -f obfuscated_src/main.py ] || (echo "No entry after mapping" && exit 1)
          echo "Ready: entry present"

      - name: Build (script + fallback)
        shell: bash
        run: |
          set +e
          echo "Trying build_obfuscated_mac.py..."
          python build_obfuscated_mac.py
          STATUS=$?
          if [ $STATUS -ne 0 ]; then
            echo "Fallback: building directly with PyInstaller"
            # 选用 src 或 obfuscated_src 作为入口
            ENTRY="src/main.py"
            [ -f obfuscated_src/main.py ] && ENTRY="obfuscated_src/main.py"
            pyinstaller --noconfirm --onedir --windowed --name CursorProManager "$ENTRY"
          fi
          echo "Build step finished"

      - name: Package zip/dmg (robust)
        shell: bash
        run: |
          set -e
          # 找到 .app
          APP_PATH="$(find dist -maxdepth 2 -type d -name 'CursorProManager.app' -o -name '*.app' | head -n1)"
          if [ -z "$APP_PATH" ]; then
            echo "No .app found in dist:"
            ls -la dist || true
            exit 1
          fi
          echo "Using app: $APP_PATH"

          # ZIP
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "CursorProManager-mac.zip"

          # DMG
          hdiutil create -volname "CursorProManager" -srcfolder "$APP_PATH" -ov -format UDZO "CursorProManager-mac.dmg"

          # FirstRun
          mkdir -p dist
          echo "首次运行：右键应用选择打开；或在终端执行 xattr -dr com.apple.quarantine \"/Applications/$(basename "$APP_PATH")\" 后再打开。" > dist/FirstRun.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CursorProManager-mac
          path: |
            CursorProManager-mac.zip
            CursorProManager-mac.dmg
            dist/FirstRun.txt
            dist/CursorProManager.app
