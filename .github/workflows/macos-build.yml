name: Build Native M1 CursorProManager

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      license_key:
        description: '授权码 (用于构建后自动化激活测试)'
        required: false
        default: ''

jobs:
  build-m1:
    # 强制使用原生 M1 (Apple Silicon) 运行器
    runs-on: macos-14
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Build Dependencies
        run: |
          echo "正在准备原生 arm64 构建环境..."
          python -m pip install --upgrade pip setuptools wheel
          pip install PyQt6 requests PyJWT cryptography lxml DrissionPage pyinstaller psutil Cython

      - name: Build Obfuscated App (Native M1 arm64)
        run: |
          echo "开始混淆打包流程 (Cython + PyInstaller)..."
          
          LICENSE_ARG=""
          if [ -n "${{ github.event.inputs.license_key }}" ]; then
            echo "检测到输入授权码，准备执行自动化激活测试..."
            LICENSE_ARG="--activate ${{ github.event.inputs.license_key }}"
          fi

          # 自动寻找脚本位置：先找根目录，再找子文件夹
          if [ -f "build_obfuscated_mac.py" ]; then
            python build_obfuscated_mac.py $LICENSE_ARG
          elif [ -f "github_m1_build/build_obfuscated_mac.py" ]; then
            python github_m1_build/build_obfuscated_mac.py $LICENSE_ARG
          else
            echo "❌ 错误：未找到构建脚本 build_obfuscated_mac.py"
            # 列出当前目录结构帮助调试
            ls -R
            exit 1
          fi

      - name: Smoke Test & Activation Verification
        run: |
          echo "启动冒烟测试并验证激活状态..."
          # 寻找生成的二进制文件
          APP_BIN=$(find dist -type f -perm +111 -path "*/Contents/MacOS/*" | head -n 1)
          if [ -z "$APP_BIN" ]; then
            echo "❌ 错误：未找到生成的二进制程序"
            exit 1
          fi
          echo "✅ 找到程序: $APP_BIN"
          
          # 启动程序 (离屏模式)
          env QT_QPA_PLATFORM=offscreen "$APP_BIN" & PID=$!
          
          echo "等待 10 秒进行运行观察..."
          sleep 10
          
          if kill -0 $PID 2>/dev/null; then
            echo "✅ 冒烟测试通过：程序运行正常"
            # 停止程序
            kill $PID
            wait $PID 2>/dev/null || true
          else
            echo "❌ 冒烟测试失败：程序在启动后 10 秒内崩溃"
            exit 1
          fi

      - name: Cleanup Activation Data (Ensure Clean Package)
        if: always()
        run: |
          echo "正在清理激活痕迹，确保分发包纯净..."
          # 运行 cleanup 脚本
          if [ -f "build_obfuscated_mac.py" ]; then
            python build_obfuscated_mac.py --cleanup
          elif [ -f "github_m1_build/build_obfuscated_mac.py" ]; then
            python github_m1_build/build_obfuscated_mac.py --cleanup
          fi
          echo "✅ 清理完成"

      - name: Package Artifacts
        run: |
          echo "正在打包产物..."
          # 寻找 .app 目录
          APP_PATH=$(find dist -maxdepth 1 -type d -name "CursorProManager_M1_*.app" | head -n 1)
          APP_NAME=$(basename "$APP_PATH")
          # 移除扩展属性并压缩
          xattr -cr "$APP_PATH"
          cd dist
          zip -r "../${APP_NAME}.zip" "$APP_NAME"
          echo "✅ 打包完成: ${APP_NAME}.zip"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: CursorProManager-M1-Obfuscated
          path: "*.zip"
