name: macos-build
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      license_key_input:
        description: "ä¸´æ—¶æˆæƒç ï¼ˆä»…ç”¨äºCIå†’çƒŸæµ‹è¯•ï¼‰"
        required: false
        type: string

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/pip
            ~/.cache/pip
          key: pip-${{ runner.os }}-py311-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-py311-

      - name: Install dependencies (robust)
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          PKGS="pyinstaller PyQt6 requests PyJWT cryptography lxml DrissionPage pyinstaller-hooks-contrib psutil"
          for i in 1 2 3; do
            python -m pip install --progress-bar off --default-timeout=120 $PKGS && break || { echo "retry..."; sleep 10; }
          done
          # éªŒè¯ä¾èµ–å®‰è£…
          python -c "
          required = ['PyQt6', 'requests', 'PyJWT', 'cryptography', 'lxml', 'DrissionPage', 'psutil']
          missing = []
          for lib in required:
              try:
                  __import__(lib)
                  print(f'âœ… {lib} å·²å®‰è£…')
              except ImportError:
                  missing.append(lib)
                  print(f'âŒ {lib} æœªå®‰è£…')
          if missing:
              print(f'âš ï¸ ç¼ºå°‘ä¾èµ–: {missing}')
              exit(1)
          else:
              print('ğŸ‰ æ‰€æœ‰ä¾èµ–å®‰è£…æˆåŠŸ')
          "
          # æ˜¾ç¤ºå®‰è£…çš„åŒ…ç‰ˆæœ¬
          python -m pip list | grep -E "PyQt6|requests|PyJWT|cryptography|lxml|DrissionPage|psutil|pyinstaller"

      - name: Setup Rosetta and x86_64 Python (Miniconda)
        shell: bash
        run: |
          set -e
          softwareupdate --install-rosetta --agree-to-license || true
          curl -L https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -o miniconda_x64.sh
          arch -x86_64 bash miniconda_x64.sh -b -p "$HOME/miniconda-x86_64"
          "$HOME/miniconda-x86_64/bin/conda" create -y -n py311 python=3.11
          PKGS="pyinstaller PyQt6 requests PyJWT cryptography lxml DrissionPage pyinstaller-hooks-contrib psutil"
          arch -x86_64 "$HOME/miniconda-x86_64/bin/conda" run -n py311 python -m pip install --progress-bar off --default-timeout=120 $PKGS
          # éªŒè¯ x86_64 ç¯å¢ƒçš„ä¾èµ–å®‰è£…
          arch -x86_64 "$HOME/miniconda-x86_64/bin/conda" run -n py311 python -c "
          required = ['PyQt6', 'requests', 'PyJWT', 'cryptography', 'lxml', 'DrissionPage', 'psutil']
          missing = []
          for lib in required:
              try:
                  __import__(lib)
                  print(f'âœ… {lib} å·²å®‰è£…')
              except ImportError:
                  missing.append(lib)
                  print(f'âŒ {lib} æœªå®‰è£…')
          if missing:
              print(f'âš ï¸ ç¼ºå°‘ä¾èµ–: {missing}')
              exit(1)
          else:
              print('ğŸ‰ æ‰€æœ‰ä¾èµ–å®‰è£…æˆåŠŸ')
          "
          # æ˜¾ç¤º x86_64 ç¯å¢ƒå®‰è£…çš„åŒ…ç‰ˆæœ¬
          arch -x86_64 "$HOME/miniconda-x86_64/bin/conda" run -n py311 python -m pip list | grep -E "PyQt6|requests|PyJWT|cryptography|lxml|DrissionPage|psutil|pyinstaller"

      - name: Unpack sources
        shell: bash
        run: |
          set -e
          if [ -f src.zip ]; then
            echo "Unpacking via ditto..."
            ditto -x -k src.zip .
          else
            echo "src.zip not found; using repo tree if present"
          fi
          echo "Find main.py:"; find . -maxdepth 3 -type f -name main.py || true

      - name: Build (script + fallback with dynamic entry)
        shell: bash
        run: |
          set +e
          ENTRY=""
          if [ -f src/main.py ]; then
            ENTRY="src/main.py"
          elif [ -f main.py ]; then
            ENTRY="main.py"
          else
            FOUND="$(find . -maxdepth 25 -type f -name main.py | head -n1)"
            [ -n "$FOUND" ] && ENTRY="$FOUND"
          fi
          echo "Selected ENTRY: ${ENTRY:-<none>}"

          if [ -f build_obfuscated_mac.py ]; then
            echo "Trying build_obfuscated_mac.py..."
            python build_obfuscated_mac.py
            STATUS=$?
          else
            STATUS=1
          fi

          if [ $STATUS -ne 0 ]; then
            echo "Fallback: building directly with PyInstaller"
            if [ -z "$ENTRY" ]; then
              echo "No main.py found; creating minimal src/main.py"
              rm -rf src && mkdir -p src
              printf '%s\n' \
                'import sys' \
                'from PyQt6.QtWidgets import QApplication, QLabel' \
                'if __name__ == "__main__":' \
                '    app = QApplication(sys.argv)' \
                '    label = QLabel("CursorProManager (placeholder build)")' \
                '    label.show()' \
                '    sys.exit(app.exec())' \
                > src/main.py
              ENTRY="src/main.py"
            fi
            HOOK="$RUNNER_TEMP/rth_alias_logger.py"
            printf '%s\n' \
              "import sys" \
              "mod = None" \
              "try:" \
              "    import src.utils.logger as mod" \
              "except Exception:" \
              "    try:" \
              "        import utils.logger as mod" \
              "    except Exception:" \
              "        mod = None" \
              "if mod:" \
              "    sys.modules['src.utils.logger'] = mod" \
              "    sys.modules['utils.logger'] = mod" \
              "cfg = None" \
              "try:" \
              "    import src.utils.config as cfg" \
              "except Exception:" \
              "    try:" \
              "        import utils.config as cfg" \
              "    except Exception:" \
              "        cfg = None" \
              "if cfg:" \
              "    sys.modules['src.utils.config'] = cfg" \
              "    sys.modules['utils.config'] = cfg" \
              > "$HOOK"
            SMOKE_HOOK="$RUNNER_TEMP/smoke_ui_hook.py"
            printf '%s\n' \
              "import os, sys, importlib" \
              "if not (os.environ.get('UI_SMOKE') or os.environ.get('CI')):" \
              "    raise SystemExit(0)" \
              "print('[UI_SMOKE] Hook å·²åŠ è½½')" \
              "TARGETS = ['è®¾ç½®','å…³äº','æ³¨å†Œ','Settings','About','Register','Activate','Verify','æ¿€æ´»','éªŒè¯','æ ¡éªŒ','ç«‹å³æ¿€æ´»']" \
              "INPUT_KEYS = ['æ¿€æ´»ç ','æˆæƒç ','æ³¨å†Œç ','License','Activation','Key','Code']" \
              "try:" \
              "    QtCore = importlib.import_module('PyQt6.QtCore')" \
              "    QtWidgets = importlib.import_module('PyQt6.QtWidgets')" \
              "except Exception as e:" \
              "    print(f\"[UI_SMOKE] åˆå§‹åŒ–å¼‚å¸¸: {e}\")" \
              "    raise SystemExit(0)" \
              "def _walk(w):" \
              "    yield w" \
              "    for c in w.findChildren(QtWidgets.QWidget):" \
              "        for x in _walk(c):" \
              "            yield x" \
              "def _do_click():" \
              "    app = QtWidgets.QApplication.instance()" \
              "    if not app:" \
              "        return" \
              "    print('[UI_SMOKE] å¼€å§‹éå†æ§ä»¶')" \
              "    clicked = 0" \
              "    tried_input = False" \
              "    key = os.environ.get('UI_SMOKE_KEY','TEST-CI-DUMMY')" \
              "    for w in app.topLevelWidgets():" \
              "        for c in _walk(w):" \
              "            try:" \
              "                is_le = isinstance(c, QtWidgets.QLineEdit)" \
              "            except Exception:" \
              "                is_le = False" \
              "            if is_le and not tried_input:" \
              "                try:" \
              "                    ph = c.placeholderText() or ''" \
              "                except Exception:" \
              "                    ph = ''" \
              "                nm = c.objectName() or ''" \
              "                ok = any(k.lower() in (ph.lower()+nm.lower()) for k in INPUT_KEYS)" \
              "                if ok:" \
              "                    try:" \
              "                        c.setText(key)" \
              "                        print('[UI_SMOKE] è¾“å…¥æ¿€æ´»ç ï¼ˆå·²é®è”½ï¼‰')" \
              "                        tried_input = True" \
              "                    except Exception as e:" \
              "                        print(f\"[UI_SMOKE] è¾“å…¥å¼‚å¸¸: {e}\")" \
              "            try:" \
              "                txt = c.text() if hasattr(c,'text') else ''" \
              "            except Exception:" \
              "                txt = ''" \
              "            obj = c.objectName() or ''" \
              "            for k in TARGETS:" \
              "                if (txt and k.lower() in txt.lower()) or (obj and k.lower() in obj.lower()):" \
              "                    try:" \
              "                        if hasattr(c,'click'):" \
              "                            c.click()" \
              "                        elif hasattr(c,'trigger'):" \
              "                            c.trigger()" \
              "                        print(f\"[UI_SMOKE] ç‚¹å‡»: {txt or obj}\")" \
              "                        clicked += 1" \
              "                        break" \
              "                    except Exception as e:" \
              "                        print(f\"[UI_SMOKE] ç‚¹å‡»å¼‚å¸¸: {e}\")" \
              "    if clicked == 0:" \
              "        # å°è¯•ç‚¹å‡»é»˜è®¤æŒ‰é’®æˆ–æ¥å—å¯¹è¯æ¡†" \
              "        try:" \
              "            for w in app.topLevelWidgets():" \
              "                for c in _walk(w):" \
              "                    try:" \
              "                        is_btn = isinstance(c, QtWidgets.QPushButton)" \
              "                        is_def = is_btn and hasattr(c,'isDefault') and c.isDefault()" \
              "                    except Exception:" \
              "                        is_def = False" \
              "                    if is_def:" \
              "                        try:" \
              "                            c.click()" \
              "                            print('[UI_SMOKE] ç‚¹å‡»é»˜è®¤æŒ‰é’®')" \
              "                            clicked += 1" \
              "                            raise StopIteration" \
              "                        except Exception as e:" \
              "                            print(f\"[UI_SMOKE] é»˜è®¤æŒ‰é’®ç‚¹å‡»å¼‚å¸¸: {e}\")" \
              "        except StopIteration:" \
              "            pass" \
              "        if clicked == 0:" \
              "            # å°è¯•æ¥å—å¯¹è¯æ¡†" \
              "            try:" \
              "                for w in app.topLevelWidgets():" \
              "                    if isinstance(w, QtWidgets.QDialog):" \
              "                        w.accept()" \
              "                        print('[UI_SMOKE] è°ƒç”¨å¯¹è¯æ¡†æ¥å—(accept)')" \
              "                        clicked += 1" \
              "                        break" \
              "            except Exception as e:" \
              "                print(f\"[UI_SMOKE] å¯¹è¯æ¡†æ¥å—å¼‚å¸¸: {e}\")" \
              "    if clicked == 0:" \
              "        print('[UI_SMOKE] æœªæ‰¾åˆ°ç›®æ ‡æ§ä»¶ï¼Œå¯èƒ½ä½¿ç”¨äº†è‡ªå®šä¹‰ç»„ä»¶æˆ–ä¸åŒæ–‡æ¡ˆ')" \
              "def _patch_exec():" \
              "    try:" \
              "        orig = QtWidgets.QApplication.exec" \
              "        def _wrapped(self):" \
              "            QtCore.QTimer.singleShot(1000, _do_click)" \
              "            QtCore.QTimer.singleShot(9000, QtWidgets.QApplication.quit)" \
              "            return orig(self)" \
              "        QtWidgets.QApplication.exec = _wrapped" \
              "        print('[UI_SMOKE] å·²æŒ‚è½½å®šæ—¶å™¨')" \
              "    except Exception as e:" \
              "        print(f\"[UI_SMOKE] Patch QApplication.exec å¤±è´¥: {e}\")" \
              "_patch_exec()" \
              > "$SMOKE_HOOK"
            PATH_ARGS=""
            [ -d src ] && PATH_ARGS="$PATH_ARGS --paths=src"
            [ -d obfuscated_src ] && PATH_ARGS="$PATH_ARGS --paths=obfuscated_src"
            [ -d obfuscated_src/src ] && PATH_ARGS="$PATH_ARGS --paths=obfuscated_src/src"
            pyinstaller --noconfirm --onedir --windowed --name CursorProManager \
              $PATH_ARGS \
              --runtime-hook "$HOOK" \
              --runtime-hook "$SMOKE_HOOK" \
              --hidden-import=logging.handlers --hidden-import=logging.config \
              --hidden-import=cryptography --hidden-import=cryptography.hazmat \
              --hidden-import=cryptography.hazmat.backends \
              --hidden-import=cryptography.hazmat.primitives \
              --hidden-import=cryptography.hazmat.primitives.padding \
              --hidden-import=cryptography.hazmat.primitives.serialization \
              --hidden-import=cryptography.hazmat.primitives.hashes \
              --hidden-import=cryptography.hazmat.primitives.ciphers \
              --hidden-import=cryptography.hazmat.primitives.ciphers.modes \
              --hidden-import=cryptography.hazmat.primitives.ciphers.algorithms \
              --hidden-import=cryptography.hazmat.primitives.asymmetric \
              --hidden-import=cryptography.hazmat.primitives.asymmetric.padding \
              --hidden-import=jwt --hidden-import=psutil --hidden-import=imaplib \
              --hidden-import=email --hidden-import=email.header --hidden-import=email.utils \
              --hidden-import=uuid --hidden-import=DrissionPage \
              --hidden-import=ui.about_widget --hidden-import=ui.settings_widget \
              --hidden-import=ui.account_pool_widget --hidden-import=ui.email_config_widget \
              --hidden-import=ui.registration_widget --hidden-import=ui.account_detail_dialog \
              --hidden-import=ui.add_account_dialog --hidden-import=core.registration_engine \
              --hidden-import=core.account_manager --hidden-import=core.auth_injector \
              --hidden-import=core.backend_api --hidden-import=core.cursor_api \
              --hidden-import=core.email_handler --hidden-import=core.legacy_email_handler \
              --hidden-import=core.drission_modules --hidden-import=core.drission_modules.account_storage \
              --hidden-import=core.drission_modules.auto_register --hidden-import=core.drission_modules.browser_manager \
              --hidden-import=core.drission_modules.card_pool_manager --hidden-import=core.drission_modules.country_codes \
              --hidden-import=core.drission_modules.cursor_switcher --hidden-import=core.drission_modules.deep_token_getter \
              --hidden-import=core.drission_modules.email_verification --hidden-import=core.drission_modules.machine_id_generator \
              --hidden-import=core.drission_modules.payment_handler --hidden-import=core.drission_modules.phone_handler \
              --hidden-import=core.drission_modules.registration_steps --hidden-import=core.drission_modules.token_handler \
              --hidden-import=core.drission_modules.turnstile_handler --hidden-import=core.drission_modules.us_address_generator \
              --hidden-import=src.ui.about_widget --hidden-import=src.ui.settings_widget \
              --hidden-import=src.ui.account_pool_widget --hidden-import=src.ui.email_config_widget \
              --hidden-import=src.ui.registration_widget --hidden-import=src.ui.account_detail_dialog \
              --hidden-import=src.ui.add_account_dialog --hidden-import=src.core.registration_engine \
              --hidden-import=src.core.account_manager --hidden-import=src.core.auth_injector \
              --hidden-import=src.core.backend_api --hidden-import=src.core.cursor_api \
              --hidden-import=src.core.email_handler --hidden-import=src.core.legacy_email_handler \
              --hidden-import=src.core.drission_modules --hidden-import=src.core.drission_modules.account_storage \
              --hidden-import=src.core.drission_modules.auto_register --hidden-import=src.core.drission_modules.browser_manager \
              --hidden-import=src.core.drission_modules.card_pool_manager --hidden-import=src.core.drission_modules.country_codes \
              --hidden-import=src.core.drission_modules.cursor_switcher --hidden-import=src.core.drission_modules.deep_token_getter \
              --hidden-import=src.core.drission_modules.email_verification --hidden-import=src.core.drission_modules.machine_id_generator \
              --hidden-import=src.core.drission_modules.payment_handler --hidden-import=src.core.drission_modules.phone_handler \
              --hidden-import=src.core.drission_modules.registration_steps --hidden-import=src.core.drission_modules.token_handler \
              --hidden-import=src.core.drission_modules.turnstile_handler --hidden-import=src.core.drission_modules.us_address_generator \
              --hidden-import=src.utils.crypto --hidden-import=src.utils.app_paths \
              --hidden-import=src.utils.version_checker --hidden-import=src.utils.license_monitor \
              --hidden-import=src.utils.logger --hidden-import=utils.logger \
              --hidden-import=src.utils.config --hidden-import=utils.config "$ENTRY"
          fi
          echo "Build step finished"

      - name: Build x86_64 with Rosetta (if available)
        shell: bash
        run: |
          set -e
          ENTRY=""
          if [ -f src/main.py ]; then
            ENTRY="src/main.py"
          elif [ -f main.py ]; then
            ENTRY="main.py"
          else
            FOUND="$(find . -maxdepth 25 -type f -name main.py | head -n1)"
            [ -n "$FOUND" ] && ENTRY="$FOUND"
          fi
          echo "Selected ENTRY: ${ENTRY:-<none>}"
          if [ -z "$ENTRY" ]; then
            exit 0
          fi
          if [ -d "$HOME/miniconda-x86_64" ]; then
            echo "Building x86_64 via conda env py311..."
            HOOK="$RUNNER_TEMP/rth_alias_logger.py"
            printf '%s\n' \
              "import sys" \
              "mod = None" \
              "try:" \
              "    import src.utils.logger as mod" \
              "except Exception:" \
              "    try:" \
              "        import utils.logger as mod" \
              "    except Exception:" \
              "        mod = None" \
              "if mod:" \
              "    sys.modules['src.utils.logger'] = mod" \
              "    sys.modules['utils.logger'] = mod" \
              "cfg = None" \
              "try:" \
              "    import src.utils.config as cfg" \
              "except Exception:" \
              "    try:" \
              "        import utils.config as cfg" \
              "    except Exception:" \
              "        cfg = None" \
              "if cfg:" \
              "    sys.modules['src.utils.config'] = cfg" \
              "    sys.modules['utils.config'] = cfg" \
              > "$HOOK"
            SMOKE_HOOK="$RUNNER_TEMP/smoke_ui_hook.py"
            printf '%s\n' \
              "import os, sys, importlib" \
              "if not (os.environ.get('UI_SMOKE') or os.environ.get('CI')):" \
              "    raise SystemExit(0)" \
              "print('[UI_SMOKE] Hook å·²åŠ è½½')" \
              "TARGETS = ['è®¾ç½®','å…³äº','æ³¨å†Œ','Settings','About','Register','Activate','Verify','æ¿€æ´»','éªŒè¯','æ ¡éªŒ','ç«‹å³æ¿€æ´»']" \
              "INPUT_KEYS = ['æ¿€æ´»ç ','æˆæƒç ','æ³¨å†Œç ','License','Activation','Key','Code']" \
              "try:" \
              "    QtCore = importlib.import_module('PyQt6.QtCore')" \
              "    QtWidgets = importlib.import_module('PyQt6.QtWidgets')" \
              "except Exception as e:" \
              "    print(f\"[UI_SMOKE] åˆå§‹åŒ–å¼‚å¸¸: {e}\")" \
              "    raise SystemExit(0)" \
              "def _walk(w):" \
              "    yield w" \
              "    for c in w.findChildren(QtWidgets.QWidget):" \
              "        for x in _walk(c):" \
              "            yield x" \
              "def _do_click():" \
              "    app = QtWidgets.QApplication.instance()" \
              "    if not app:" \
              "        return" \
              "    clicked = 0" \
              "    tried_input = False" \
              "    key = os.environ.get('UI_SMOKE_KEY','TEST-CI-DUMMY')" \
              "    for w in app.topLevelWidgets():" \
              "        for c in _walk(w):" \
              "            try:" \
              "                is_le = isinstance(c, QtWidgets.QLineEdit)" \
              "            except Exception:" \
              "                is_le = False" \
              "            if is_le and not tried_input:" \
              "                try:" \
              "                    ph = c.placeholderText() or ''" \
              "                except Exception:" \
              "                    ph = ''" \
              "                nm = c.objectName() or ''" \
              "                ok = any(k.lower() in (ph.lower()+nm.lower()) for k in INPUT_KEYS)" \
              "                if ok:" \
              "                    try:" \
              "                        c.setText(key)" \
              "                        print('[UI_SMOKE] è¾“å…¥æ¿€æ´»ç ï¼ˆå·²é®è”½ï¼‰')" \
              "                        tried_input = True" \
              "                    except Exception as e:" \
              "                        print(f\"[UI_SMOKE] è¾“å…¥å¼‚å¸¸: {e}\")" \
              "            try:" \
              "                txt = c.text() if hasattr(c,'text') else ''" \
              "            except Exception:" \
              "                txt = ''" \
              "            obj = c.objectName() or ''" \
              "            for k in TARGETS:" \
              "                if (txt and k.lower() in txt.lower()) or (obj and k.lower() in obj.lower()):" \
              "                    try:" \
              "                        if hasattr(c,'click'):" \
              "                            c.click()" \
              "                        elif hasattr(c,'trigger'):" \
              "                            c.trigger()" \
              "                        print(f\"[UI_SMOKE] ç‚¹å‡»: {txt or obj}\")" \
              "                        clicked += 1" \
              "                        break" \
              "                    except Exception as e:" \
              "                        print(f\"[UI_SMOKE] ç‚¹å‡»å¼‚å¸¸: {e}\")" \
              "    if clicked == 0:" \
              "        print('[UI_SMOKE] æœªæ‰¾åˆ°ç›®æ ‡æ§ä»¶ï¼Œå¯èƒ½ä½¿ç”¨äº†è‡ªå®šä¹‰ç»„ä»¶æˆ–ä¸åŒæ–‡æ¡ˆ')" \
              "def _patch_exec():" \
              "    try:" \
              "        orig = QtWidgets.QApplication.exec" \
              "        def _wrapped(self):" \
              "            QtCore.QTimer.singleShot(1000, _do_click)" \
              "            QtCore.QTimer.singleShot(9000, QtWidgets.QApplication.quit)" \
              "            return orig(self)" \
              "        QtWidgets.QApplication.exec = _wrapped" \
              "        print('[UI_SMOKE] å·²æŒ‚è½½å®šæ—¶å™¨')" \
              "    except Exception as e:" \
              "        print(f\"[UI_SMOKE] Patch QApplication.exec å¤±è´¥: {e}\")" \
              "_patch_exec()" \
              > "$SMOKE_HOOK"
            PATH_ARGS=""
            [ -d src ] && PATH_ARGS="$PATH_ARGS --paths=src"
            [ -d obfuscated_src ] && PATH_ARGS="$PATH_ARGS --paths=obfuscated_src"
            [ -d obfuscated_src/src ] && PATH_ARGS="$PATH_ARGS --paths=obfuscated_src/src"
            arch -x86_64 "$HOME/miniconda-x86_64/bin/conda" run -n py311 pyinstaller --noconfirm --onedir --windowed --name CursorProManager-x86_64 \
              $PATH_ARGS \
              --runtime-hook "$HOOK" \
              --runtime-hook "$SMOKE_HOOK" \
              --hidden-import=logging.handlers --hidden-import=logging.config \
              --hidden-import=cryptography --hidden-import=cryptography.hazmat \
              --hidden-import=cryptography.hazmat.backends \
              --hidden-import=cryptography.hazmat.primitives \
              --hidden-import=cryptography.hazmat.primitives.padding \
              --hidden-import=cryptography.hazmat.primitives.serialization \
              --hidden-import=cryptography.hazmat.primitives.hashes \
              --hidden-import=cryptography.hazmat.primitives.ciphers \
              --hidden-import=cryptography.hazmat.primitives.ciphers.modes \
              --hidden-import=cryptography.hazmat.primitives.ciphers.algorithms \
              --hidden-import=cryptography.hazmat.primitives.asymmetric \
              --hidden-import=cryptography.hazmat.primitives.asymmetric.padding \
              --hidden-import=jwt --hidden-import=psutil --hidden-import=imaplib \
              --hidden-import=email --hidden-import=email.header --hidden-import=email.utils \
              --hidden-import=uuid --hidden-import=DrissionPage \
              --hidden-import=ui.about_widget --hidden-import=ui.settings_widget \
              --hidden-import=ui.account_pool_widget --hidden-import=ui.email_config_widget \
              --hidden-import=ui.registration_widget --hidden-import=ui.account_detail_dialog \
              --hidden-import=ui.add_account_dialog --hidden-import=core.registration_engine \
              --hidden-import=core.account_manager --hidden-import=core.auth_injector \
              --hidden-import=core.backend_api --hidden-import=core.cursor_api \
              --hidden-import=core.email_handler --hidden-import=core.legacy_email_handler \
              --hidden-import=core.drission_modules --hidden-import=core.drission_modules.account_storage \
              --hidden-import=core.drission_modules.auto_register --hidden-import=core.drission_modules.browser_manager \
              --hidden-import=core.drission_modules.card_pool_manager --hidden-import=core.drission_modules.country_codes \
              --hidden-import=core.drission_modules.cursor_switcher --hidden-import=core.drission_modules.deep_token_getter \
              --hidden-import=core.drission_modules.email_verification --hidden-import=core.drission_modules.machine_id_generator \
              --hidden-import=core.drission_modules.payment_handler --hidden-import=core.drission_modules.phone_handler \
              --hidden-import=core.drission_modules.registration_steps --hidden-import=core.drission_modules.token_handler \
              --hidden-import=core.drission_modules.turnstile_handler --hidden-import=core.drission_modules.us_address_generator \
              --hidden-import=src.ui.about_widget --hidden-import=src.ui.settings_widget \
              --hidden-import=src.ui.account_pool_widget --hidden-import=src.ui.email_config_widget \
              --hidden-import=src.ui.registration_widget --hidden-import=src.ui.account_detail_dialog \
              --hidden-import=src.ui.add_account_dialog --hidden-import=src.core.registration_engine \
              --hidden-import=src.core.account_manager --hidden-import=src.core.auth_injector \
              --hidden-import=src.core.backend_api --hidden-import=src.core.cursor_api \
              --hidden-import=src.core.email_handler --hidden-import=src.core.legacy_email_handler \
              --hidden-import=src.core.drission_modules --hidden-import=src.core.drission_modules.account_storage \
              --hidden-import=src.core.drission_modules.auto_register --hidden-import=src.core.drission_modules.browser_manager \
              --hidden-import=src.core.drission_modules.card_pool_manager --hidden-import=src.core.drission_modules.country_codes \
              --hidden-import=src.core.drission_modules.cursor_switcher --hidden-import=src.core.drission_modules.deep_token_getter \
              --hidden-import=src.core.drission_modules.email_verification --hidden-import=src.core.drission_modules.machine_id_generator \
              --hidden-import=src.core.drission_modules.payment_handler --hidden-import=src.core.drission_modules.phone_handler \
              --hidden-import=src.core.drission_modules.registration_steps --hidden-import=src.core.drission_modules.token_handler \
              --hidden-import=src.core.drission_modules.turnstile_handler --hidden-import=src.core.drission_modules.us_address_generator \
              --hidden-import=src.utils.crypto --hidden-import=src.utils.app_paths \
              --hidden-import=src.utils.version_checker --hidden-import=src.utils.license_monitor \
              --hidden-import=src.utils.logger --hidden-import=utils.logger \
              --hidden-import=src.utils.config --hidden-import=utils.config "$ENTRY"
          else
            echo "x86_64 environment not found; skipping x86_64 build."
          fi
          echo "x86_64 build step finished"

      - name: Package zip/dmg (robust)
        shell: bash
        run: |
          set -e
          APPS=$(find dist -type d -name '*.app')
          if [ -z "$APPS" ]; then
            echo "No .app found in dist"; ls -la dist || true; exit 1
          fi
          for APP_PATH in $APPS; do
            echo "Using app: $APP_PATH"
            xattr -cr "$APP_PATH" || true
            BIN="$(find "$APP_PATH/Contents/MacOS" -type f | head -n1)"
            ARCH="$(file -b "$BIN" | awk '{print $1}')"
            SUFFIX="mac"
            if echo "$ARCH" | grep -qi "x86_64"; then SUFFIX="mac-x86_64"; fi
            if echo "$ARCH" | grep -qi "arm64"; then SUFFIX="mac-arm64"; fi
            ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "CursorProManager-${SUFFIX}.zip"
            hdiutil create -volname "CursorProManager" -srcfolder "$APP_PATH" -ov -format UDZO "CursorProManager-${SUFFIX}.dmg"
          done
          mkdir -p dist
          echo "é¦–æ¬¡è¿è¡Œï¼šå°† .app æ‹·è´åˆ° /Applications åï¼Œå³é”®é€‰æ‹©æ‰“å¼€ï¼›æˆ–åœ¨ç»ˆç«¯æ‰§è¡Œ xattr -dr com.apple.quarantine \"/Applications/CursorProManager.app\" å†æ‰“å¼€ã€‚Apple Silicon ä½¿ç”¨ arm64 åŒ…ï¼ŒIntel ä½¿ç”¨ x86_64 åŒ…ã€‚" > dist/FirstRun.txt

      - name: Smoke-run apps (offscreen)
        shell: bash
        run: |
          set +e
          APPS=$(find dist -type d -name '*.app')
          if [ -z "$APPS" ]; then
            echo "No .app for smoke-run"; exit 0
          fi
          for APP_PATH in $APPS; do
            echo "ã€æ— ç•Œé¢å¥åº·æ£€æŸ¥ã€‘ç›®æ ‡åº”ç”¨ï¼š$APP_PATH"
            BIN="$(find "$APP_PATH/Contents/MacOS" -type f | head -n1)"
            ARCH="$(file -b "$BIN")"
            echo "äºŒè¿›åˆ¶è·¯å¾„ï¼š$BIN"
            echo "äºŒè¿›åˆ¶æ¶æ„ï¼š$ARCH"
            # é€‰æ‹©å¹³å°æ’ä»¶å¹¶è®¾ç½® QT_PLUGIN_PATH
            PLAT_DIR=""
            for d in \
              "$APP_PATH/Contents/MacOS/PyQt6/Qt6/plugins/platforms" \
              "$APP_PATH/Contents/MacOS/Qt6/plugins/platforms" \
              "$APP_PATH/Contents/Resources/PyQt6/Qt6/plugins/platforms" ; do
              if [ -d "$d" ]; then PLAT_DIR="$d"; break; fi
            done
            PLUGIN_ROOT="$(dirname "$PLAT_DIR")"
            PLATFORM="offscreen"
            if [ -d "$PLAT_DIR" ] && ! ls "$PLAT_DIR" | grep -qi offscreen; then
              PLATFORM="cocoa"
            fi
            echo "æ£€æµ‹åˆ°å¹³å°æ’ä»¶ç›®å½•ï¼š${PLAT_DIR:-<æœªæ‰¾åˆ°>}"
            echo "é€‰æ‹©å¹³å°ï¼š$PLATFORM"
            echo "ä»¥ $PLATFORM æ¨¡å¼å¯åŠ¨ï¼Œå€’è®¡æ—¶ 5 ç§’è§‚å¯Ÿåˆå§‹åŒ–æ—¥å¿—â€¦"
            QT_PLUGIN_PATH="$PLUGIN_ROOT" QT_QPA_PLATFORM="$PLATFORM" "$BIN" & PID=$!
            for i in 5 4 3 2 1; do
              echo "ç­‰å¾… ${i} ç§’â€¦"
              sleep 1
            done
            echo "ç»“æŸè¿›ç¨‹å¹¶æ”¶é›†é€€å‡ºçŠ¶æ€â€¦"
            kill "$PID" 2>/dev/null || true
            wait "$PID"; CODE=$?
            echo "è¿›ç¨‹é€€å‡ºç ï¼š$CODE"
            if [ "$CODE" -eq 143 ] || [ "$CODE" -eq 0 ]; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆåº”ç”¨å·²æˆåŠŸåˆå§‹åŒ–ï¼Œéšåè¢«æµ‹è¯•è„šæœ¬æ­£å¸¸ç»ˆæ­¢ï¼‰"
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆé€€å‡ºç ï¼š$CODEï¼‰"
              exit 1
            fi
          done

      - name: éªŒè¯æ ¸å¿ƒåŠŸèƒ½
        shell: bash
        run: |
          set +e
          APP_PATH="$(find dist -type d -name '*.app' | head -n1)"
          if [ -z "$APP_PATH" ]; then
            echo "æœªæ‰¾åˆ° .app"; exit 1
          fi
          BIN="$(find "$APP_PATH/Contents/MacOS" -type f | head -n1)"
          # å¹³å°æ’ä»¶æ£€æµ‹ä¸é€‰æ‹©
          PLAT_DIR=""
          for d in \
            "$APP_PATH/Contents/MacOS/PyQt6/Qt6/plugins/platforms" \
            "$APP_PATH/Contents/MacOS/Qt6/plugins/platforms" \
            "$APP_PATH/Contents/Resources/PyQt6/Qt6/plugins/platforms" ; do
            if [ -d "$d" ]; then PLAT_DIR="$d"; break; fi
          done
          PLUGIN_ROOT="$(dirname "$PLAT_DIR")"
          PLATFORM="offscreen"
          if [ -d "$PLAT_DIR" ] && ! ls "$PLAT_DIR" | grep -qi offscreen; then
            PLATFORM="cocoa"
          fi
          echo "æ ¸å¿ƒåŠŸèƒ½éªŒè¯ä½¿ç”¨å¹³å°ï¼š$PLATFORM"
          # å¯åŠ¨å¹¶æ•è·è¾“å‡º
          OUT="/tmp/app_output.log"
          : > "$OUT"
          QT_PLUGIN_PATH="$PLUGIN_ROOT" QT_QPA_PLATFORM="$PLATFORM" "$BIN" >"$OUT" 2>&1 & APP_PID=$!
          for i in 5 4 3 2 1; do
            echo "åŠŸèƒ½éªŒè¯å€’è®¡æ—¶ ${i} ç§’â€¦"; sleep 1;
          done
          kill -TERM "$APP_PID" 2>/dev/null || true
          # æœ€å¤šå†ç­‰å¾… 5 ç§’ï¼Œè¶…æ—¶åˆ™å¼ºæ€
          for t in 1 2 3 4 5; do
            if ! ps -p "$APP_PID" >/dev/null 2>&1; then break; fi
            sleep 1
          done
          if ps -p "$APP_PID" >/dev/null 2>&1; then
            echo "è¿›ç¨‹æœªæŒ‰æ—¶é€€å‡ºï¼Œå‘é€ KILL"
            kill -KILL "$APP_PID" 2>/dev/null || true
          fi
          wait "$APP_PID" 2>/dev/null || true
          # å…œåº•æ¸…ç†å¯èƒ½é—ç•™çš„å­è¿›ç¨‹
          pkill -f "$BIN" 2>/dev/null || true
          echo "=== åŠŸèƒ½éªŒè¯ ==="
          # éªŒè¯1: åœ¨çº¿æ ¡éªŒæ–‡æ¡ˆ
          if grep -q "æ­£åœ¨è¿›è¡Œå¯åŠ¨æ—¶åœ¨çº¿æ ¡éªŒ" "$OUT"; then
            echo "âœ… åœ¨çº¿æ ¡éªŒåŠŸèƒ½æ­£å¸¸"
          else
            echo "âŒ åœ¨çº¿æ ¡éªŒåŠŸèƒ½å¯èƒ½æœ‰é—®é¢˜"; exit 1
          fi
          # éªŒè¯2: æ—¥å¿—ç³»ç»Ÿ
          if grep -q "cursor_vip.LicenseValidator" "$OUT"; then
            echo "âœ… æ—¥å¿—ç³»ç»Ÿæ­£å¸¸"
          else
            echo "âŒ æ—¥å¿—ç³»ç»Ÿå¯èƒ½æœ‰é—®é¢˜"; exit 1
          fi
          # éªŒè¯3: æœ‰ WARNING / INFO
          if grep -q "WARNING" "$OUT" && grep -q "INFO" "$OUT"; then
            echo "âœ… é”™è¯¯å’Œè­¦å‘Šå¤„ç†æ­£å¸¸"
          else
            echo "âš ï¸ æœªæ£€æµ‹åˆ° WARNING/INFO æ—¥å¿—"
          fi
          # éªŒè¯4: æ— å´©æºƒç—•è¿¹
          if ! grep -Eq "Traceback|Aborted|Segmentation fault" "$OUT"; then
            echo "âœ… åº”ç”¨è¿è¡Œç¨³å®šï¼Œæ— å´©æºƒ"
          else
            echo "âŒ åº”ç”¨å¯èƒ½å´©æºƒäº†"; exit 1
          fi
          echo "ğŸ‰ æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éªŒè¯é€šè¿‡ï¼"

      - name: äº¤äº’æŒ‰é”®å†’çƒŸæµ‹è¯•
        env:
          UI_SMOKE_KEY: ${{ secrets.LICENSE_KEY }}
          LICENSE_KEY_INPUT: ${{ inputs.license_key_input }}
        shell: bash
        run: |
          set +e
          APP_PATH="$(find dist -type d -name '*.app' | head -n1)"
          if [ -z "$APP_PATH" ]; then
            echo "æœªæ‰¾åˆ° .app"; exit 1
          fi
          BIN="$(find "$APP_PATH/Contents/MacOS" -type f | head -n1)"
          PLAT_DIR=""
          for d in \
            "$APP_PATH/Contents/MacOS/PyQt6/Qt6/plugins/platforms" \
            "$APP_PATH/Contents/MacOS/Qt6/plugins/platforms" \
            "$APP_PATH/Contents/Resources/PyQt6/Qt6/plugins/platforms" ; do
            if [ -d "$d" ]; then PLAT_DIR="$d"; break; fi
          done
          PLUGIN_ROOT="$(dirname "$PLAT_DIR")"
          PLATFORM="offscreen"
          if [ -d "$PLAT_DIR" ] && ! ls "$PLAT_DIR" | grep -qi offscreen; then
            PLATFORM="cocoa"
          fi
          OUT="/tmp/ui_smoke.log"
          : > "$OUT"
          echo "=== äº¤äº’æŒ‰é”®å†’çƒŸæµ‹è¯•ï¼ˆ$PLATFORMï¼‰ ==="
          UI_KEY="${UI_SMOKE_KEY:-$LICENSE_KEY_INPUT}"
          UI_KEY="${UI_KEY:-CI-TEST-DUMMY}"
          QT_PLUGIN_PATH="$PLUGIN_ROOT" QT_QPA_PLATFORM="$PLATFORM" UI_SMOKE=1 UI_SMOKE_KEY="$UI_KEY" "$BIN" >"$OUT" 2>&1 & PID=$!
          for i in 10 9 8 7 6 5 4 3 2 1; do
            echo "äº¤äº’æµ‹è¯•å€’è®¡æ—¶ ${i} ç§’â€¦"; sleep 1;
          done
          kill -TERM "$PID" 2>/dev/null || true
          for t in 1 2 3 4 5; do
            if ! ps -p "$PID" >/dev/null 2>&1; then break; fi
            sleep 1
          done
          if ps -p "$PID" >/dev/null 2>&1; then
            kill -KILL "$PID" 2>/dev/null || true
          fi
          wait "$PID" 2>/dev/null; CODE=$?
          pkill -f "$BIN" 2>/dev/null || true
          echo "--- æœ€è¿‘æ—¥å¿— ---"
          tail -n 200 "$OUT" || true
          echo "é€€å‡ºç ï¼š$CODE"
          if grep -q "\\[UI_SMOKE\\] ç‚¹å‡»:" "$OUT" || grep -q "\\[UI_SMOKE\\] æœªæ‰¾åˆ°ç›®æ ‡æ§ä»¶" "$OUT" || grep -q "\\[UI_SMOKE\\] Hook å·²åŠ è½½" "$OUT" || grep -q "\\[UI_SMOKE\\] å·²æŒ‚è½½å®šæ—¶å™¨" "$OUT"; then
            echo "âœ… å†’çƒŸ Hook å·²æ‰§è¡Œ"
          else
            echo "âŒ æœªæ•è·åˆ°å†’çƒŸæ—¥å¿—"; exit 1
          fi
          if ! grep -Eq "Traceback|Aborted|Segmentation fault" "$OUT"; then
            echo "âœ… æ— å´©æºƒç—•è¿¹"
          else
            echo "âŒ å­˜åœ¨å´©æºƒç—•è¿¹"; exit 1
          fi
          if [ "$CODE" -eq 143 ] || [ "$CODE" -eq 0 ]; then
            echo "âœ… äº¤äº’æŒ‰é”®å†’çƒŸæµ‹è¯•é€šè¿‡"
          else
            echo "âŒ äº¤äº’æŒ‰é”®å†’çƒŸæµ‹è¯•å¤±è´¥ï¼ˆé€€å‡ºç ï¼š$CODEï¼‰"; exit 1
          fi

      - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
        shell: bash
        run: |
          set +e
          APP_PATH="$(find dist -type d -name '*.app' | head -n1)"
          if [ -z "$APP_PATH" ]; then
            echo "æœªæ‰¾åˆ° .app"; exit 1
          fi
          BIN="$(find "$APP_PATH/Contents/MacOS" -type f | head -n1)"
          # å¹³å°æ’ä»¶æ£€æµ‹ä¸é€‰æ‹©
          PLAT_DIR=""
          for d in \
            "$APP_PATH/Contents/MacOS/PyQt6/Qt6/plugins/platforms" \
            "$APP_PATH/Contents/MacOS/Qt6/plugins/platforms" \
            "$APP_PATH/Contents/Resources/PyQt6/Qt6/plugins/platforms" ; do
            if [ -d "$d" ]; then PLAT_DIR="$d"; break; fi
          done
          PLUGIN_ROOT="$(dirname "$PLAT_DIR")"
          PLATFORM="offscreen"
          if [ -d "$PLAT_DIR" ] && ! ls "$PLAT_DIR" | grep -qi offscreen; then
            PLATFORM="cocoa"
          fi
          echo "=== æ€§èƒ½åŸºå‡†æµ‹è¯• ==="
          echo "å¯åŠ¨æ—¶é—´ï¼ˆè¿‘ä¼¼ï¼‰:"
          time (
            QT_PLUGIN_PATH="$PLUGIN_ROOT" QT_QPA_PLATFORM="$PLATFORM" "$BIN" >/dev/null 2>&1 & PID=$!
            sleep 3
            kill -TERM "$PID" 2>/dev/null || true
            for t in 1 2 3 4 5; do
              if ! ps -p "$PID" >/dev/null 2>&1; then break; fi
              sleep 1
            done
            if ps -p "$PID" >/dev/null 2>&1; then
              kill -KILL "$PID" 2>/dev/null || true
            fi
            wait "$PID" 2>/dev/null || true
          )
          echo ""
          echo "åº”ç”¨å¤§å°ç»Ÿè®¡:"
          du -sh "$APP_PATH" || true
          echo "äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°:"
          du -h "$BIN" || true
          echo ""
          echo "å¯åŠ¨æ—¶å†…å­˜ä½¿ç”¨ï¼ˆè¿‘ä¼¼ï¼‰:"
          QT_PLUGIN_PATH="$PLUGIN_ROOT" QT_QPA_PLATFORM="$PLATFORM" "$BIN" >/dev/null 2>&1 & PID=$!
          sleep 2
          ps -p $PID -o rss=,vsz=,pcpu= 2>/dev/null || echo "è¿›ç¨‹å·²ç»“æŸ"
          kill -TERM $PID 2>/dev/null || true
          for t in 1 2 3 4 5; do
            if ! ps -p "$PID" >/dev/null 2>&1; then break; fi
            sleep 1
          done
          if ps -p "$PID" >/dev/null 2>&1; then
            kill -KILL "$PID" 2>/dev/null || true
          fi
          wait "$PID" 2>/dev/null || true
          pkill -f "$BIN" 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CursorProManager-mac-all
          path: |
            CursorProManager-mac-arm64.zip
            CursorProManager-mac-arm64.dmg
            CursorProManager-mac-x86_64.zip
            CursorProManager-mac-x86_64.dmg
            dist/FirstRun.txt
            dist/**/*.app
