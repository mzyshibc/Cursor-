name: macos-build
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/pip
            ~/.cache/pip
          key: pip-${{ runner.os }}-py311-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-py311-

      - name: Install dependencies (robust)
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          PKGS="pyinstaller PyQt6 requests PyJWT cryptography lxml DrissionPage pyinstaller-hooks-contrib psutil"
          for i in 1 2 3; do
            python -m pip install --progress-bar off --default-timeout=120 $PKGS && break || { echo "retry..."; sleep 10; }
          done

      - name: Unpack sources
        shell: bash
        run: |
          set -e
          if [ -f src.zip ]; then
            echo "Unpacking via ditto..."
            ditto -x -k src.zip .
          else
            echo "src.zip not found; using repo tree if present"
          fi
          echo "Find main.py:"; find . -maxdepth 3 -type f -name main.py || true

      - name: Build (script + fallback with dynamic entry)
        shell: bash
        run: |
          set +e
          ENTRY=""
          if [ -f src/main.py ]; then
            ENTRY="src/main.py"
          elif [ -f main.py ]; then
            ENTRY="main.py"
          else
            FOUND="$(find . -maxdepth 25 -type f -name main.py | head -n1)"
            [ -n "$FOUND" ] && ENTRY="$FOUND"
          fi
          echo "Selected ENTRY: ${ENTRY:-<none>}"

          if [ -f build_obfuscated_mac.py ]; then
            echo "Trying build_obfuscated_mac.py..."
            python build_obfuscated_mac.py
            STATUS=$?
          else
            STATUS=1
          fi

          if [ $STATUS -ne 0 ]; then
            echo "Fallback: building directly with PyInstaller"
            if [ -z "$ENTRY" ]; then
              echo "No main.py found; creating minimal src/main.py"
              rm -rf src && mkdir -p src
              printf '%s\n' \
                'import sys' \
                'from PyQt6.QtWidgets import QApplication, QLabel' \
                'if __name__ == "__main__":' \
                '    app = QApplication(sys.argv)' \
                '    label = QLabel("CursorProManager (placeholder build)")' \
                '    label.show()' \
                '    sys.exit(app.exec())' \
                > src/main.py
              ENTRY="src/main.py"
            fi
            pyinstaller --noconfirm --onedir --windowed --name CursorProManager "$ENTRY"
          fi
          echo "Build step finished"

      - name: Package zip/dmg (robust)
        shell: bash
        run: |
          set -e
          APP_PATH="$(find dist -type d $ -name 'CursorProManager.app' -o -name '*.app' $ | head -n1)"
          if [ -z "$APP_PATH" ]; then
            echo "No .app found in dist"; ls -la dist || true; exit 1
          fi
          echo "Using app: $APP_PATH"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "CursorProManager-mac.zip"
          hdiutil create -volname "CursorProManager" -srcfolder "$APP_PATH" -ov -format UDZO "CursorProManager-mac.dmg"
          mkdir -p dist
          echo "首次运行：右键应用选择打开；或在终端执行 xattr -dr com.apple.quarantine \"/Applications/$(basename "$APP_PATH")\" 后再打开。" > dist/FirstRun.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CursorProManager-mac
          path: |
            CursorProManager-mac.zip
            CursorProManager-mac.dmg
            dist/FirstRun.txt
            dist/**/*.app
